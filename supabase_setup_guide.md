# Supabaseセットアップ手順書：リアルタイム投票機能の実装

この手順書に従って、ブログのリアルタイム投票機能に必要なデータベース（DB）をセットアップします。所要時間は約10分です。

---

## Step 1: Supabaseアカウント作成とプロジェクト開始

1.  **[Supabase公式サイト](https://supabase.com/)にアクセス**し、`Start your project` をクリックします。
2.  **`Sign up with GitHub`** を選択し、あなたのGitHubアカウント（`Siitake-man`）でサインアップします。
3.  ログイン後、`New Project` ボタンをクリックします。
4.  **プロジェクト名**を `the-jury-votes` と入力します。
5.  **データベースのパスワード**を生成（`Generate a password`）し、安全な場所にメモしておきます（後で使うことはほぼありません）。
6.  **リージョン**は `Northeast Asia (Tokyo)` を選択します。
7.  `Create new project` をクリックします。プロジェクトの準備が完了するまで2分ほど待ちます。

---

## Step 2: 投票テーブルと集計関数の作成

1.  プロジェクトの管理画面が開いたら、左メニューから **SQL Editor**（一番下の `</>` アイコン）を選択します。
2.  `+ New query` をクリックします。
3.  以下のSQLコードをすべてコピーして、エディタ画面に貼り付けます。

```sql
-- 投票結果を保存するテーブルを作成
CREATE TABLE public.votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  article_id TEXT NOT NULL,
  character TEXT NOT NULL,
  count BIGINT DEFAULT 1 NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  -- 同じ記事IDとキャラクターの組み合わせは1行だけにする制約
  UNIQUE (article_id, character)
);

-- 誰でも読み取りはできるように設定
ALTER TABLE public.votes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read access" ON public.votes FOR SELECT USING (true);

-- 投票数をインクリメントするための関数を作成
CREATE OR REPLACE FUNCTION increment_vote(p_article_id TEXT, p_character TEXT)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  -- 存在すればカウントを+1、存在しなければ新しい行を挿入
  INSERT INTO public.votes (article_id, character, count)
  VALUES (p_article_id, p_character, 1)
  ON CONFLICT (article_id, character)
  DO UPDATE SET count = votes.count + 1;
END;
$$;

-- 誰でもこの関数を実行できるように権限を付与
GRANT EXECUTE ON FUNCTION increment_vote(TEXT, TEXT) TO anon;
```

4.  `RUN` ボタン（緑色）をクリックして、SQLを実行します。`Success. No rows returned` と表示されれば成功です。

---

## Step 3: APIキーの取得

次に、生成したHTMLからこのDBに接続するための「APIキー」を取得します。

1.  左メニューから **Settings**（歯車アイコン）→ **API** を選択します。
2.  `Project API keys` のセクションに、2つの重要な情報が表示されています。

    - **Project URL**: `https://xxxxxxxx.supabase.co` という形式のURL
    - **Project API Keys** > `anon` `public`: `ey...` から始まる非常に長い文字列

3.  この2つの値をコピーして、安全な場所にメモしておいてください。**特に `anon public` キーは外部に公開しても安全なキーです。**

---

## 次のステップ

お疲れ様でした！以上でデータベースの準備は完了です。

取得した **`Project URL`** と **`anon public` キー**を私に教えてください。その2つの情報をビルドスクリプトに組み込み、GitHubにすべてをアップロードすれば、ブログの公開と自動化が完了します。
